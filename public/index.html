<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat App</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      #messages {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: scroll;
        padding: 10px;
        margin-bottom: 10px;
      }
      #messages div {
        margin-bottom: 5px;
      }
      input {
        margin-right: 5px;
      }
    </style>
  </head>
  <body>
    <h2>WebSocket Chat</h2>

    <label>Username: <input id="username" /></label>
    <label>Room: <input id="room" /></label>
    <button onclick="joinChat()">Join</button>

    <div id="messages"></div>

    <input id="input" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>

    <script>
      let ws;
      let userId;

      function joinChat() {
        if (ws) ws.close();
        document.getElementById('messages').innerHTML = '';
        const username = document.getElementById('username').value;
        const room = document.getElementById('room').value;

        ws = new WebSocket('ws://localhost:3000');

        ws.onopen = () => {
          console.log('Connected to WebSocket');
        };

        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          console.log('Received:', msg);

          if (msg.type === 'Welcome') {
            userId = msg.userId;

            ws.send(JSON.stringify({ type: 'SET_USERNAME', username }));
            ws.send(JSON.stringify({ type: 'JOIN_ROOM', room }));
          }

          if (msg.type === 'JOINED_ROOM') {
            addMessage(`✅ Joined room: ${msg.room}`);
          }

          if (msg.type === 'CHAT') {
            const time = new Date(msg.timestamp).toLocaleTimeString();
            addMessage(`[${time}] ${msg.username}: ${msg.message}`);
          }

          if (msg.type === 'ERROR') {
            addMessage(`❌ Error: ${msg.message}`);
          }
        };
      }

      function sendMessage() {
        const input = document.getElementById('input');
        const message = input.value;
        input.value = '';

        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'CHAT', message }));
        }
      }

      function addMessage(text) {
        const div = document.createElement('div');
        div.textContent = text;
        document.getElementById('messages').appendChild(div);
      }
    </script>
  </body>
</html>
